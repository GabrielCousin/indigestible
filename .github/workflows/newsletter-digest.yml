name: Newsletter Digest

on:
  # Run every Monday at 6:00 AM UTC (8:00 AM Paris time in winter, 7:00 AM in summer)
  schedule:
    - cron: '0 6 * * 1'

  # Allow manual trigger
  workflow_dispatch:

# Set timezone for the workflow
env:
  TZ: Europe/Paris

jobs:
  fetch-and-create-issue:
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: uv sync

      - name: Fetch newsletter content
        run: uv run python src/main.py
        continue-on-error: false

      - name: Generate AI summary
        run: uv run python src/summarize.py
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        continue-on-error: false

      - name: Check if output directory exists
        id: check_output
        run: |
          if [ -d "output" ] && [ "$(ls -A output)" ]; then
            echo "has_content=true" >> $GITHUB_OUTPUT
          else
            echo "has_content=false" >> $GITHUB_OUTPUT
          fi

      - name: Prepare issue content
        if: steps.check_output.outputs.has_content == 'true'
        id: prepare_issue
        run: |
          # Create issue body file
          ISSUE_FILE="issue_body.md"

          # Check if AI summary exists
          if [ -f "output/SUMMARY.md" ]; then
            echo "Using AI-generated summary"

            # Add header
            cat > "$ISSUE_FILE" << 'EOF'
          # ðŸ¤– Weekly Newsletter Digest (AI Summary)

          This is an AI-curated summary of this week's newsletters, organized by topic.

          ---

          EOF

            # Add the AI summary content (skip any metadata lines at the top)
            tail -n +1 "output/SUMMARY.md" >> "$ISSUE_FILE"

          else
            echo "No AI summary found, using raw content"

            # Add header
            cat > "$ISSUE_FILE" << 'EOF'
          # Weekly Newsletter Digest

          This is an automated digest of newsletters for the week.

          ---

          EOF

            # Add table of contents
            echo "## ðŸ“š Table of Contents" >> "$ISSUE_FILE"
            echo "" >> "$ISSUE_FILE"

            for file in output/*_content.md; do
              if [ -f "$file" ]; then
                # Extract source name from filename
                basename=$(basename "$file" _content.md)
                source_name=$(echo "$basename" | sed 's/_/ /g' | sed 's/\b\(.\)/\u\1/g')

                # Create anchor link
                anchor=$(echo "$source_name" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | tr -d '.')
                echo "- [$source_name](#$anchor)" >> "$ISSUE_FILE"
              fi
            done

            echo "" >> "$ISSUE_FILE"
            echo "---" >> "$ISSUE_FILE"
            echo "" >> "$ISSUE_FILE"

            # Add each newsletter content
            for file in output/*_content.md; do
              if [ -f "$file" ]; then
                basename=$(basename "$file" _content.md)
                source_name=$(echo "$basename" | sed 's/_/ /g' | sed 's/\b\(.\)/\u\1/g')

                echo "" >> "$ISSUE_FILE"
                echo "## $source_name" >> "$ISSUE_FILE"
                echo "" >> "$ISSUE_FILE"

                # Add collapsible section for long content
                echo "<details>" >> "$ISSUE_FILE"
                echo "<summary>Click to expand</summary>" >> "$ISSUE_FILE"
                echo "" >> "$ISSUE_FILE"

                # Get first 5 lines (metadata) and skip them for the collapsed content
                tail -n +7 "$file" >> "$ISSUE_FILE"

                echo "" >> "$ISSUE_FILE"
                echo "</details>" >> "$ISSUE_FILE"
                echo "" >> "$ISSUE_FILE"
                echo "---" >> "$ISSUE_FILE"
                echo "" >> "$ISSUE_FILE"
              fi
            done
          fi

          echo "issue_file=$ISSUE_FILE" >> $GITHUB_OUTPUT

      - name: Create GitHub Issue
        if: steps.check_output.outputs.has_content == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const issueFile = '${{ steps.prepare_issue.outputs.issue_file }}';

            // Read the issue body
            const issueBody = fs.readFileSync(issueFile, 'utf8');

            // Get current date for the title
            const now = new Date();
            const options = {
              timeZone: 'Europe/Paris',
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            };
            const dateStr = now.toLocaleDateString('en-US', options);

            // Check if we have an AI summary
            const hasSummary = fs.existsSync('output/SUMMARY.md');
            const titlePrefix = hasSummary ? 'ðŸ¤– AI Newsletter Digest' : 'ðŸ“° Newsletter Digest';

            // Create the issue
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `${titlePrefix} - ${dateStr}`,
              body: issueBody,
              labels: ['newsletter', 'automated']
            });

            console.log(`Created issue #${issue.data.number}: ${issue.data.html_url}`);

      - name: Upload output as artifact
        if: steps.check_output.outputs.has_content == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: newsletter-output
          path: output/
          retention-days: 30

      - name: Report failure
        if: failure()
        run: |
          echo "::error::Newsletter digest workflow failed. Check the logs for details."
